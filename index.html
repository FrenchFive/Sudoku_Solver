<!DOCTYPE html>
<html>
<head>
    <title>Sudoku Solver</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Enter Sudoku</h1>
        <form method="POST" action="/" onsubmit="showLoading(event);" autocomplete="off">
            <table>
                <!-- Python script dynamically fills the rows and cells -->
                {table_rows}
            </table>
            <input type="submit" value="Solve" id="solveButton">
            <input type="button" value="Clear" id="clearButton" onclick="clearBoard()">
            <div id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Solving... Please wait.</p>
            </div>
        </form>
        <div id="stats" style="display: none;"></div>
    </div>
    <script>
        window.onload = function() {
            console.log('JavaScript is running');
    
            window.showLoading = function(event) {
                event.preventDefault(); // Prevent the default form submission
                console.log('showLoading called');
                document.getElementById('solveButton').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
    
                // Start checking for solution
                checkSolution();
    
                // Serialize the form data
                var form = document.querySelector('form');
                var formData = new FormData(form);
                var urlEncodedData = new URLSearchParams();
    
                for (var pair of formData.entries()) {
                    urlEncodedData.append(pair[0], pair[1]);
                }
    
                fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: urlEncodedData.toString()
                })
                .then(function(response) {
                    console.log('Form submitted via AJAX');
                })
                .catch(function(error) {
                    console.error('Error submitting form:', error);
                });
            };

            function checkSolution() {
                console.log('Checking for solution...');
                fetch('/solution')
                    .then(function(response) {
                        console.log('Received response with status:', response.status);
                        if (response.status === 200) {
                            return response.json();
                        } else {
                            // Solution not ready, try again
                            console.log('Solution not ready, retrying...');
                            setTimeout(checkSolution, 1000);
                            return null;
                        }
                    })
                    .then(function(data) {
                        if (data) {
                            console.log('Solution data received:', data);
                            displaySolution(data.solution, data.original, data.attempts, data.backtracks);
                        }
                    })
                    .catch(function(error) {
                        console.error('Error fetching solution:', error);
                        setTimeout(checkSolution, 1000);
                    });
            }

            function displaySolution(solution, original, attempts, backtracks) {
                console.log('Displaying solution...');
                document.getElementById('loading').style.display = 'none';

                for (var i = 0; i < 9; i++) {
                    for (var j = 0; j < 9; j++) {
                        var input = document.querySelector('input[name="cell_' + i + '_' + j + '"]');
                        if (input) {
                            input.value = solution[i][j];
                            if (original[i][j] === 0) {
                                input.classList.add('solver-filled');
                            }
                        }
                    }
                }

                var statsDiv = document.getElementById('stats');
                statsDiv.textContent = 'Attempts: ' + attempts + ' | Backtracks: ' + backtracks;
                statsDiv.style.display = 'block';
                document.getElementById('solveButton').style.display = 'inline-block';
            }

            document.addEventListener("keydown", function(e) {
                var activeElement = document.activeElement;

                // Check if the active element is an input
                if (activeElement.tagName === "INPUT" && activeElement.type === "text") {
                    if (!isNaN(e.key) && e.key !== " " && e.key !== "0") {
                        // Replace the content of the input with the pressed key (non-zero numbers)
                        activeElement.value = e.key;
                        e.preventDefault(); // Prevent default behavior
                    } else if (e.key === "0" || e.key === "Backspace" || e.key === "Delete") {
                        // Clear the input when "0", "Backspace", or "Delete" is pressed
                        activeElement.value = "";
                        e.preventDefault(); // Prevent default behavior
                    }

                    // Handle arrow key navigation
                    var currentCell = activeElement.parentElement;
                    var row = currentCell.parentElement;
                    var nextInput = null;

                    switch (e.key) {
                        case "ArrowUp":
                            if (row.previousElementSibling && row.previousElementSibling.children[currentCell.cellIndex]) {
                                nextInput = row.previousElementSibling.children[currentCell.cellIndex].querySelector("input");
                            }
                            break;
                        case "ArrowDown":
                            if (row.nextElementSibling && row.nextElementSibling.children[currentCell.cellIndex]) {
                                nextInput = row.nextElementSibling.children[currentCell.cellIndex].querySelector("input");
                            }
                            break;
                        case "ArrowLeft":
                            if (currentCell.previousElementSibling) {
                                nextInput = currentCell.previousElementSibling.querySelector("input");
                            }
                            break;
                        case "ArrowRight":
                            if (currentCell.nextElementSibling) {
                                nextInput = currentCell.nextElementSibling.querySelector("input");
                            }
                            break;
                    }

                    // Move focus to the next input if available
                    if (nextInput) {
                        nextInput.focus();
                        e.preventDefault();
                    }
                }
            });

            window.clearBoard = function() {
                var inputs = document.querySelectorAll('td input[type="text"]');
                inputs.forEach(function(input) {
                    input.value = '';
                    input.classList.remove('solver-filled');
                });
                document.getElementById('stats').style.display = 'none';
            };
        };
    </script>
</body>
</html>
